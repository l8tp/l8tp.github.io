<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">

    <style>
        table{
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 0.9em;
            font-family: sans-serif;
            min-width: 400px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
        }
        table thead tr{
            background-color: #009879;
            color: #ffffff;
            text-align: left;
        }
        table th, table td{
            padding: 12px 15px;
        }
        table tbody tr{
            border-bottom: 1px solid rgb(0, 0, 0);
        }
        table tbody tr:nth-of-type(even) {
            background-color: #f3f3f3;
        }
    
        table tbody tr:last-of-type {
            border-bottom: 2px solid #009879;
        }
        label{
            justify-content: flex-start;
        }
        .filter{
            display: flex;
            flex-direction: column;
            gap: 10px; 
            flex-wrap: wrap;
            padding: 0 10px 10px 10px;
            background-color: #c0e2ff;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            width: 100%;
            position: absolute; 
            z-index: 998;
            /* */

        }
        .inputarea{
            display: flex;
            flex-direction: column;
        }
        .xtitle:hover{color: #000000;}
    </style>
</head>
<body>
    <div id="message"></div>
    <div id="tablecontainer">
        <table>
            <thead>
                <tr></tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="filter" style="display: none;">
        <div class="inputarea">
            <label id="marketLable">超市: </label>
            <input type="text" id="marketInput" name="marketInput" placeholder="选择三个以下的超市">
        </div>
        <div id="marketList" class="bluelist"></div>
        <div class="inputarea">
            <label id="wareLable">商品: </label>
            <input type="text" id="wareInput" name="wareInput" placeholder="选择所需商品">
        </div>
        <div id="wareList" class="bluelist"></div>
        <button id="submitselect">选择完成</button>
    </div>
    <div class="bottom-tab-bar"></div>
    <script src="js/bottombar.js"></script>
    <script>
        const API_URL = window.location.origin + '/api';
        let currentToken = localStorage.getItem('token') || '';

        //第一次渲染表格
        (async function renderTable() {
            const container = document.getElementById('tablecontainer');
            const theadtr = container.querySelector('thead > tr');
            const tbody = container.querySelector('tbody');
            //监听点击后展开此行的时间
            tbody.addEventListener('click', (e)=>{
                const tr = e.target.closest('tr');
                console.log(tr)
                tr.querySelectorAll('p').forEach(element => {
                    element.style.display = 'block';
                });

            })

            const  response = await fetch('json/ware.json');
            const ware = await response.json();
            theadtr.innerHTML = `<th class='xtitle' onclick='filter()'>商品\\超市▼</th>`

            const markets = ware.market.slice(0,2);
            for (let i of markets){
                theadtr.innerHTML += `<th>${i}</th>`
            };
            tbody.innerHTML = ''
            for (let i of ware.ware){
                tbody.innerHTML += `<tr><th>${i}</th></tr>`
            };
            const tbodytrs = tbody.querySelectorAll('tr');
            getpricenote(tbodytrs, markets);

        })();

        //获取价格数据
        async function getpricenote(tbodytrs, markets) {
            const message = document.getElementById('message');
            message.innerHTML = '价格加载中...'
            try {
                const response = await fetch(`${API_URL}/products/getpricenote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({  token: currentToken, markets })
                });
                const result = await response.json();
                
                if (result.success) {
                    console.log('获取到了所有超市的价格记录')
                    
                    if (result.data) {
                        message.innerHTML = `共${result.data.length}个超市的记录：`
                        //遍历每个超市
                        for (let j of result.data){
                            const data = Object.entries(j);
                            //遍历表格体的每一行
                            for (let i of tbodytrs){
                                //遍历超市的商品
                                for (const [ware, priceJson] of data) {
                                    const price = priceJson.price;
                                    const unit = priceJson.unit;
                                    const time = priceJson.createdAt;
                                    if (ware === i.querySelector('th').innerHTML){
                                        i.innerHTML += `<th>${price}${unit}<p style='display:none'>时间：${time.split(' ')[0]}</p></th>`
                                    }
                                }
                            }
                        }
                    }
                } else {
                    alert(result.message);
                }
             } catch (error) {
                alert('网络错误，请检查服务器是否运行');
                message.innerHTML=error
            }
        }

        let poptimes = 0;
        //筛选超市和商品
        async function filter (){
            poptimes++;
            console.log(`第${poptimes}次弹窗`)
            const filter = document.querySelector('.filter')
            filter.style.display = 'flex'
            const  response = await fetch('json/ware.json');
            const ware = await response.json();
            const marketLable = document.getElementById('marketLable');
            const marketInput = document.getElementById('marketInput');
            const marketList = document.getElementById('marketList');
            const wareLable = document.getElementById('wareLable');
            const wareInput = document.getElementById('wareInput');
            const wareList = document.getElementById('wareList');

            if (poptimes < 2){
                const button = document.getElementById('submitselect');
                button.addEventListener('click', ()=>{closefilter(filter, marketLable, wareLable, ware)})

                loadlist(marketLable, marketList, ware.market)
                loadlist(wareLable, wareList, ware.ware)
            }

            InputFilter(marketLable, marketInput, marketList, ware.market)
            InputFilter(wareLable, wareInput, wareList, ware.ware)

        }

        //根据输入筛选列表
        function InputFilter(lable, Input, list, data){
            Input.addEventListener('input', ()=>{
                const inputValue = Input.value.trim();

                //获取标签列表
                const spannodes = lable.querySelectorAll('span');
                const spans = [];
                for (let i of spannodes){
                    spans.push(i.innerHTML.slice(0, -1));
                }
                //获取候选列表
                const anodes = list.querySelectorAll('.list-item');
                for (let i of anodes){
                    i.style.display = 'block'
                    //剔除标签列表
                    if (spans.includes(i.innerHTML)){
                        i.style.display = 'none'
                    }
                    //剔除不符合输入框的
                    if (!i.innerHTML.includes(inputValue)){
                        i.style.display = 'none'
                    }
                }
            });
        }


        
        //加载候选列表的函数
        function loadlist(label, List, data){
            //加载列表
            List.innerHTML = ''
            for (let i of data){
                List.innerHTML += `<a class="list-item">${i}</a>`
            }

            //监视列表点击赋值给标签
            List.addEventListener('click', (e)=>{
                if (List === document.getElementById('marketList')){
                    const spannodes = label.querySelectorAll('span');
                    if (spannodes.length > 2){
                        return message.innerHTML = '只能选择三个超市'
                    }
                }

                const i = e.target;
                if (i !== List){
                    const span = document.createElement('span');
                    span.innerHTML = i.innerHTML + '&times;'
                    label.appendChild(span);
                    i.style.display = 'none';

                    //监视标签内容点击标签删除标签
                    span.addEventListener('click', ()=>{
                        span.remove();
                        i.style.display = 'block'
                    })
                }
            })
        }

        //关闭筛选弹窗开始重新渲染表格
        function closefilter(filter, marketLable, wareLable, ware){
            filter.style.display = 'none';
            
            const marketnodes = marketLable.querySelectorAll('span');
            const warenodes = wareLable.querySelectorAll('span');
            if(!marketnodes.length || !warenodes.length){
                message.innerHTML = '请选择超市和商品';
                return
            }
            const container = document.getElementById('tablecontainer');
            const theadtr = container.querySelector('thead > tr');
            const tbody = container.querySelector('tbody');

            let markets = []
            theadtr.innerHTML = `<th class='xtitle' onclick='filter()'>商品\\超市▼</th>`
            for (let i of marketnodes){
                theadtr.innerHTML += `<th>${i.innerHTML.slice(0, -1)}</th>`
                markets.push(i.innerHTML.slice(0, -1));
            };
            tbody.innerHTML = ''
            for (let i of warenodes){
                tbody.innerHTML += `<tr><th>${i.innerHTML.slice(0, -1)}</th></tr>`
            };
            const tbodytrs = tbody.querySelectorAll('tr');
           getpricenote(tbodytrs, markets);
        }

    </script>
</body>
</html>
