<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>超市自助比价</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">

    <style>
        body{padding: 15px 10px 100px 10px;}
        h1{
            text-align: center;
            font-size: 20px;
        }
        table{
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 18px;
            font-family: sans-serif;
            min-width: 300px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
        }
        table thead tr{
            background-color: #7db1ff;
            text-align: left;
            font-size: 20px;
            line-height: 22px;
            height: 50px;
        }
        table p {
            font-size: 15px;
        }
        table th, table td{
            padding: 2px;
            border-width:0 2px;
            border-style: solid;
            border-color: #ffffff;
        }
        table tbody tr{
            border-bottom: 1px solid rgb(0, 0, 0);
        }
        table tbody tr:nth-of-type(even) {
            background-color: #f3f3f3;
        }
    
        table tbody tr:last-of-type {
            border-bottom: 2px solid #009879;
        }
        label{
            justify-content: flex-start;
            font-size: 20px;
            margin-bottom: 10px;
        }
        label span{
            color: green;
            cursor: pointer;
        }
        label span::after{
            content: '×';
            cursor: pointer;
        }
        hr{
            border-color: #000000;
            height: 2px;
        }
        .filter{
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 10px; 
            flex-wrap: wrap;
            padding: 10px;
            height: calc(100vh - 150px);
            min-height: 650px;
            background-color: #eaf5ff;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            margin: 0 10px;
            position: absolute; 
            top: 50px;
            z-index: 998;
        }
        .inputarea{
            display: flex;
            flex-direction: column;
        }
        .inputarea>div{
            display: flex;
            gap: 3px;
        }
        .inputarea button{ width: 100px; background-color:#4e7188}
        .xtitle button{font-size: 20px; padding: 2px; height: 100%;}
        .xtitle button:hover{color: #000000;}
        .bluelist{
            background-color: transparent;
            border-width:0 0 0 2px;
            border-radius: 0;
            border-color: #ffffff;
            max-height: 150px;
        }
        .bluelist a{background-color: rgba(255, 255, 255, 0.3);}
    </style>
</head>
<body>
    <div id="message"></div>
    <div id="tablecontainer">
        <table>
            <thead>
                <tr></tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="filter" style="display: none;">
        <h1>请选择输入框下方的列表</h1>
        <div class="inputarea">
            <label id="marketLable">超市: </label>
            <div>
                <button id="clearMarketLabel" type="button">清空标签</button>
                <input type="text" id="marketInput" name="marketInput" placeholder="选择三个以下的超市">

            </div>
        </div>
        <div id="marketList" class="bluelist"></div>
        <hr>
        <div class="inputarea">
            <label id="wareLable">商品: </label>
            <div>
                <button id="clearWareLabel" type="button">清空标签</button>
                <input type="text" id="wareInput" name="wareInput" placeholder="选择所需商品">
            </div>
        </div>
        <div id="wareList" class="bluelist"></div>
        <button id="submitselect" style="background-color: #287e49;">选择完成</button>
    </div>
    <div class="bottom-tab-bar"></div>
    <script src="/js/bottombar.js"></script>
    <script>
        const API_URL = window.location.origin + '/api';
        let currentToken = localStorage.getItem('token') || '';
        let userIdTemp = localStorage.getItem('userIdTemp');
        if (!userIdTemp) {
            userIdTemp = 'userIdTemp_' + new Date().toLocaleString('zh-CN') + '_' + Math.random().toString(36).slice(2, 9) + '_1';
            localStorage.setItem('userIdTemp', userIdTemp);
        }

        //第一次渲染表格
        (async function renderTable() {
            const container = document.getElementById('tablecontainer');
            const theadtr = container.querySelector('thead > tr');
            const tbody = container.querySelector('tbody');
            //监听点击后展开此行的时间
            tbody.addEventListener('click', (e)=>{
                const tr = e.target.closest('tr');
                tr.querySelectorAll('p').forEach(element => {
                    element.style.display = 'block';
                });
            })

            const  response = await fetch('/json/ware.json');
            const ware = await response.json();
            theadtr.innerHTML = `<th class='xtitle' onclick='filter()'><button>筛选▼</button></th>`

            const markets = delAlias(ware.market.slice(0,2));
            for (let i of markets){
                theadtr.innerHTML += `<th>${i}</th>`
            };
            tbody.innerHTML = ''
            for (let i of delAlias(ware.ware)){
                tbody.innerHTML += `<tr><th>${i}</th></tr>`
            };
            const tbodytrs = tbody.querySelectorAll('tr');
            getpricenote(tbodytrs, markets);

        })();

        //去除#后面别名的函数
        function delAlias(data){
            let newdata = [];
            for (let i of data){
                i = i.split('#')[0];
                newdata.push(i);
            }
            return newdata;
        }

        //获取价格数据
        async function getpricenote(tbodytrs, markets) {
            const message = document.getElementById('message');
            message.innerHTML = '价格加载中...'
            try {
                const response = await fetch(`${API_URL}/products/getpricenote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({  token: currentToken, userIdTemp, markets })
                });
                //更新userIdTemp
                let IdTempArray = userIdTemp.split('_');
                let IdTimesStamp =  IdTempArray.pop();
                userIdTemp = IdTempArray.join('_') + '_' + (IdTimesStamp +1);
                localStorage.setItem('userIdTemp', userIdTemp);

                const result = await response.json();
                
                if (result.success) {
                    console.log('获取到了所有超市的价格记录')
                    
                    if (result.data) {
                        message.innerHTML = `共${result.data.length}个超市的记录：`
                        //遍历每个超市
                        for (let j of result.data){
                            const data = Object.entries(j);
                            //遍历表格体的每一行
                            for (let i of tbodytrs){
                                //遍历超市的商品
                                let containware = false;
                                for (const [ware, priceJson] of data) {
                                    const price = priceJson.price;
                                    const unit = priceJson.unit;
                                    const time = priceJson.createdAt;
                                    if (ware === i.querySelector('th').innerHTML){
                                        containware = true;
                                        i.innerHTML += `<th>${price}${unit}<p style='display:none'>时间：${time.split(' ')[0]}</p></th>`
                                    }
                                }
                                if (!containware){i.innerHTML += '<th></th>'}
                            }
                        }
                    }
                } else {
                    alert(result.message);
                    if (result.message === '请先登录或注册，试用次数结束') {
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        currentToken = '';
                        
                        window.location.href = '/login';
                    }
                }
             } catch (error) {
                alert('请求服务器错误');
                message.innerHTML=error
            }
        }

        let poptimes = 0;
        //筛选超市和商品
        async function filter (){
            poptimes++;
            const filter = document.querySelector('.filter')
            filter.style.display = 'flex'
            const  response = await fetch('/json/ware.json');
            const ware = await response.json();
            const marketLable = document.getElementById('marketLable');
            const marketInput = document.getElementById('marketInput');
            const marketList = document.getElementById('marketList');
            const wareLable = document.getElementById('wareLable');
            const wareInput = document.getElementById('wareInput');
            const wareList = document.getElementById('wareList');

            if (poptimes < 2){
                const button = document.getElementById('submitselect');
                button.addEventListener('click', ()=>{closefilter(filter, marketLable, wareLable, ware)})
                document.getElementById('clearMarketLabel').addEventListener('click', ()=>{
                    lableToList(marketLable, marketList);
                });
                document.getElementById('clearWareLabel').addEventListener('click', ()=>{
                    lableToList(wareLable, wareList);
                });

            // localStorage.removeItem('filters');
                const filters = JSON.parse(localStorage.getItem('filters') || null);
                let markets, wares;
                if (filters){
                    console.log('加载了上次的筛选条件')
                    markets = filters.markets;
                    wares = filters.wares;
                }
                loadlist(marketLable, marketList, ware.market, markets)
                loadlist(wareLable, wareList, ware.ware, wares)
            }

            InputFilter(marketLable, marketInput, marketList)
            InputFilter(wareLable, wareInput, wareList)

        }

        //根据输入筛选列表
        function InputFilter(lable, Input, list){
            Input.addEventListener('input', ()=>{
                const inputValue = Input.value.trim();

                //获取标签列表
                const spannodes = lable.querySelectorAll('span');
                const spans = [];
                for (let i of spannodes){
                    spans.push(i.innerHTML);
                }
                //获取候选列表
                const anodes = list.querySelectorAll('a');
                for (let i of anodes){
                    i.style.display = 'block'
                    //剔除标签列表
                    if (spans.includes(i.innerHTML)){
                        i.style.display = 'none'
                    }
                    //剔除不符合输入框的
                    if (!i.innerHTML.includes(inputValue)){
                        i.style.display = 'none'
                    }
                }
            });
        }


        
        //加载候选列表的函数
        function loadlist(label, List, data, selectedData = null){
            //加载列表
            List.innerHTML = ''
            for (let i of data){
                List.innerHTML += `<a>${i}</a>`
            }

            //监视列表点击赋值给标签
            List.addEventListener('click', (e)=>{
                if (List === document.getElementById('marketList')){
                    const spannodes = label.querySelectorAll('span');
                    if (spannodes.length > 2){
                        return message.innerHTML = '只能选择三个超市'
                    }
                }

                const i = e.target;
                if (i !== List){ listToLabel(i, label) };
            })

            //加载上次选择的标签
            if (selectedData){
                const anodes = List.querySelectorAll('a');
                for (let i of anodes){
                    if (selectedData.includes(i.innerHTML.split('#')[0])){
                        listToLabel(i, label);
                    }
                }
            }
        }

        //列表赋值给标签并隐藏列表项，点击标签删除标签并显示列表项
        function listToLabel(anode, label){
            const span = document.createElement('span');
            span.innerHTML = anode.innerHTML
            label.appendChild(span);
            anode.style.display = 'none';
            span.addEventListener('click', ()=>{
                span.remove();
                anode.style.display = 'block'
            })
        }

        //删除标签并显示列表项的函数
        function lableToList(label, list){
            const spannodes = label.querySelectorAll('span');
            for (let i of spannodes){
                const anodes = list.querySelectorAll('a');
                for (let j of anodes){
                    if (i.innerHTML === j.innerHTML){
                        j.style.display = 'block';
                    }
                }
                i.remove();
            }
        }

        //关闭筛选弹窗开始重新渲染表格
        function closefilter(filter, marketLable, wareLable, ware){
            filter.style.display = 'none';
            
            const marketnodes = marketLable.querySelectorAll('span');
            const warenodes = wareLable.querySelectorAll('span');
            if(!marketnodes.length || !warenodes.length){
                message.innerHTML = '请选择超市和商品';
                return
            }
            const container = document.getElementById('tablecontainer');
            const theadtr = container.querySelector('thead > tr');
            const tbody = container.querySelector('tbody');

            let markets = []
            theadtr.innerHTML = `<th class='xtitle' onclick='filter()'><button>筛选▼</button></th>`
            for (let i of marketnodes){
                theadtr.innerHTML += `<th>${i.innerHTML.split('#')[0]}</th>`
                markets.push(i.innerHTML.split('#')[0]);
            };
            tbody.innerHTML = ''
            const wares = []
            for (let i of warenodes){
                tbody.innerHTML += `<tr><th>${i.innerHTML.split('#')[0]}</th></tr>`
                wares.push(i.innerHTML.split('#')[0]);
            };
            //存储筛选条件到本地，下次打开弹窗自动加载
            let filters = {markets, wares};
            localStorage.setItem('filters', JSON.stringify(filters));
            const tbodytrs = tbody.querySelectorAll('tr');
            getpricenote(tbodytrs, markets);
        }

    </script>
</body>
</html>
